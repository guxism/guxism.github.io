<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>main.go</title>
  <style>body{font-size:14px;line-height:24px;color:#252519;margin:0;padding:0;background:#f5f5ff}@media print{body #background{background:0 0;border:none}body div.docs{max-width:99%;padding-left:0;padding-right:0}body div.code{margin:0;clear:both}}@media screen and (max-width:1200px){body #background{background:0 0;border:none}body div.docs{max-width:99%}body div.code{padding-top:5px;margin:0;clear:both;background:#eee;border-top:1px solid #bbb;border-bottom:1px solid #bbb}}a{text-decoration:solid underline #261a3b 2px;font-size:14px;padding:0 .2em}p{margin:0 0 15px}#container{background:#fff}#container,div.section{position:relative}#background{top:0;right:0;bottom:0;background:#f5f5ff;border-left:1px solid #e5e5ee;z-index:0;position:absolute;height:100%;left:640px}#jump_page,#jump_to{background:#fff;-webkit-box-shadow:0 0 25px #777;-moz-box-shadow:0 0 25px #777;-webkit-border-bottom-left-radius:5px;-moz-border-radius-bottomleft:5px;font:10px Arial;text-transform:uppercase;cursor:pointer;text-align:right}#jump_to,#jump_wrapper{position:fixed;right:0;top:0;padding:5px 10px}#jump_wrapper{padding:0;display:none}#jump_to:hover #jump_wrapper{display:block}#jump_page{padding:5px 0 3px;margin:0 0 25px 25px}#jump_page .source{display:block;padding:5px 10px;text-decoration:none;border-top:1px solid #eee}#jump_page .source:hover{background:#f5f5ff}div.docs{float:left;max-width:500px;min-width:500px;min-height:5px;padding:10px 25px 1px 50px;vertical-align:top;text-align:left}div p img{max-width:500px;min-width:500px}.docs pre{margin:15px 0;padding-left:15px}.docs p code,.docs p tt{background:#f8f8ff;border:1px solid #dedede;font-size:12px;padding:0 .2em}.octowrap{position:relative}.octothorpe{font:12px Arial;text-decoration:none;color:#454545;position:absolute;top:3px;left:-20px;padding:1px 2px;opacity:0;-webkit-transition:opacity .2s linear}div.docs:hover .octothorpe{opacity:1}div.code{padding:14px 15px 16px 50px;vertical-align:top}.code pre,.docs p code{font-size:12px}code,pre,tt{line-height:18px;font-family:Monaco,Consolas,"Lucida Console",monospace;margin:0;padding:0}div.clearall{clear:both}td.linenos{background-color:#f0f0f0;padding-right:10px}span.lineno{background-color:#f0f0f0;padding:0 5px}body .hll{background-color:#ffc}body .c{color:#408080;font-style:italic}body .err{border:1px solid red}body .k{color:#954121;font-weight:700}body .o{color:#666}body .cm{color:#408080;font-style:italic}body .cp{color:#bc7a00}body .c1,body .cs{color:#408080;font-style:italic}body .gd{color:#a00000}body .ge{font-style:italic}body .gr{color:red}body .gh{color:navy;font-weight:700}body .gi{color:#00a000}body .go{color:grey}body .gp{color:navy;font-weight:700}body .gs{font-weight:700}body .gu{color:purple;font-weight:700}body .gt{color:#0040d0}body .kc{color:#954121}body .kd,body .kn{color:#954121;font-weight:700}body .kp{color:#954121}body .kr{color:#954121;font-weight:700}body .kt{color:#b00040}body .m{color:#666}body .s{color:#219161}body .na{color:#7d9029}body .nb{color:#954121}body .nc{color:#00f;font-weight:700}body .no{color:#800}body .nd{color:#a2f}body .ni{color:#999;font-weight:700}body .ne{color:#d2413a;font-weight:700}body .nf{color:#00f}body .nl{color:#a0a000}body .nn{color:#00f;font-weight:700}body .nt{color:#954121;font-weight:700}body .nv{color:#19469d}body .ow{color:#a2f;font-weight:700}body .w{color:#bbb}body .sb,body .sc{color:#219161}body .sd{color:#219161;font-style:italic}body .s2{color:#219161}body .se{color:#b62;font-weight:700}body .sh{color:#219161}body .si{color:#b68;font-weight:700}body .sx{color:#954121}body .sr{color:#b68}body .s1{color:#219161}body .ss{color:#19469d}body .bp{color:#954121}body .vc,body .vg,body .vi{color:#19469d}@font-face{font-family:aller-light;src:url(/fonts/aller-light.woff) format("woff");font-weight:400;font-style:normal}body{font-family:aller-light,sans-serif;position:relative;display:inline-block;min-height:100%;min-width:100%}h1,h2,h3,h4,h5,h6{margin:20px 0 15px;line-height:1.1em}div.docs{max-width:580px;padding-left:35px}div.code{margin-left:640px;padding-top:30px;padding-bottom:3px}div.docs p{margin-bottom:5px}body .kd{font-weight:400}body .n{color:#19469d}body .il,body .mf,body .mh,body .mi,body .mo{color:#40a070}table{border-collapse:collapse;border:2px solid #c8c8c8;letter-spacing:1px;font-size:.8rem}td,th{border:1px solid #bebebe;padding:10px 20px}th{background-color:#ebebeb}td{text-align:left}caption{padding:10px}blockquote{font-size:13px;color:#353131}</style><meta name="viewport" content="width=device-width">
</head>
<body>
<div id="container">
  <div id="background"></div>
  <!-- empty code block -->
  <div class="clearall">
  <div class="section" id="section-0">
    <div class="docs">
      <div class="octowrap">
        <a class="octothorpe" href="#section-0">#</a>
      </div>
      <h1>Build A Web Service in Gin</h1>
<p>作为<a href="/blog/code/web-service-gin/main.go.html">初阶版</a>的补充和改造</p>
<h2>加入数据库</h2>
<p>http://go-database-sql.org/</p>
<p>用 PostgreSQL, <a href="https://www.sumologic.com/blog/postgresql-vs-mysql/">理由</a>? 对我个人而言没有理由, 小网站用 SQLite 都行.</p>
<p>关于驱动, 可参考 <a href="https://medium.com/avitotech/how-to-work-with-postgres-in-go-bad2dabd13e4">How to work with Postgres in Go</a>,
我决定用 <a href="https://github.com/go-pg/pg/">Golang ORM: go-pg/pg</a></p>
<p>参考 <a href="https://github.com/uptrace/go-treemux-realworld-example-app">https://github.com/uptrace/go-treemux-realworld-example-app</a></p>
<h2>目标</h2>
<ul>
<li>建一个 tracker 后端, 用户打开页面之后, 前端将用户信息发送到服务端, 服务端登记用户信息</li>
</ul>
<h2>项目结构</h2>
<p>首先划分模块, 参考 <a href="https://github.com/golang-standards/project-layout">Standard Go Project Layout</a></p>
<ul>
<li><a href="cmd/api/api.go.html">cmd/api/api.go</a>: JSON API</li>
<li><a href="cmd/migrate_db/1_init.up.sql.html">cmd/migrate_db/1_init.up.sql</a>: 数据库迁移 SQL</li>
<li><a href="cmd/migrate_db/migrate_db.go.html">cmd/migrate_db/migrate_db.go</a>: 数据库迁移二进制</li>
<li><a href="rwe/app.go.html">rwe/app.go</a>: 应用资源</li>
<li><a href="rwe/postgres.go.html">rwe/postgres.go</a>: 数据库</li>
<li><a href="rwe/router.go.html">rwe/router.go</a>: 路由</li>
<li><a href="tracker/init.go.html">tracker/init.go</a></li>
<li><a href="tracker/tracker_api.go.html">tracker/tracker_api.go</a>: 具体业务接口</li>
<li><a href="tracker/track.go.html">tracker/track.go</a></li>
<li><a href="xconfig/config.go.html">xconfig/config.go</a>: 配置</li>
</ul>
<h2>配置</h2>
<p>在根目录创建 dev.yml</p>
<pre><code>postgres_url: postgres://user:pass@localhost:5432/db_name
</code></pre>
<h2>Cross-Origin Resouce Sharing 和 Mixed content</h2>
<p>前者通过 <a href="github.com/gin-contrib/cors">github.com/gin-contrib/cors</a> 解决, 后者
通过 HTTPS</p>
<h2>go.mod</h2>
<p>在 go.mod 加上:</p>
<pre><code>replace lyfjaberg/rwe =&gt; ./rwe
replace lyfjaberg/xconfig =&gt; ./xconfig
replace lyfjaberg/tracker =&gt; ./tracker
</code></pre>
<h2>数据库迁移</h2>
<p>初始化</p>
<pre><code>go run cmd/migrate_db/*.go init
go run cmd/migrate_db/*.go
</code></pre>
<p>查看版本</p>
<pre><code>➤ go run cmd/migrate_db/*.go version
version is 2
</code></pre>
<p>语法检查工具: <a href="https://github.com/markdrago/pgsanity">markdrago/pgsanity</a></p>
<h3>将 id 改成 uuid</h3>
<ul>
<li>加入 uuid column</li>
<li>删掉 id, 重命名 uuid</li>
</ul>
<p>步骤:</p>
<pre><code># 安装扩展, 先 `pg_lscluster` 查看 pg 版本
sudo apt install postgresql-contrib-10
\c my_database
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
</code></pre>
<p>升级降级:</p>
<pre><code>➤ go run cmd/migrate_db/*.go up
migrated from 3 to 4
➤ go run cmd/migrate_db/*.go down
migrated from 4 to 3
</code></pre>
<p>需要写 SQL</p>
<pre><code>cmd/migrate_db
├── 1_create_table.down.sql
├── 1_create_table.up.sql
├── 2_add_uuid.down.sql
├── 2_add_uuid.up.sql
├── 3_remove_id.down.sql
├── 3_remove_id.up.sql
├── 4_add_other_columns.down.sql
├── 4_add_other_columns.up.sql
├── migrate_db.go
</code></pre>
<h2>测试</h2>
<pre><code>&lt;script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"&gt;&lt;/script&gt;
&lt;script&gt;

var a = {"from": window.location.href};
var u = 'https://?:8080/tracks';
$.ajax({
    type: 'POST',
    url: u,
    crossDomain: true,
    data: JSON.stringify({ track: a }),
    dataType: 'json',
    contentType: "application/json; charset=utf-8",
    success: function(responseData, textStatus, jqXHR) {
        var value = responseData.someKey;
    },
    error: function (responseData, textStatus, errorThrown) {
        alert('POST failed.');
    }
});

&lt;/script&gt;
</code></pre>
<h2>问题</h2>
<p>问题在于 IOS Safari 不让发 HTTP 请求, 甚至阻止加载我域名的图片. 问题无解.</p>
<p>更新: 只有 IOS 13 才有这问题, 禁止跨源访问某些域名的资源, 具体可能是指 Let’s Encrypt 等非权威 CA 签的域名</p>
<h2>Further ado</h2>
<p>未来可能把它开发成一个像 <a href="https://www.revolvermaps.com">https://www.revolvermaps.com</a> 那样的服务</p>
    </div>
    <div class="code">
      <div class="highlight"><pre><span></span>

</pre></div>
    </div>
  </div>
  <div class="clearall"></div>

                    <div class="section" id="section-links">
                        <div class="docs">
                            <div class="octowrap">
                                <a class="octothorpe" href="#section-links">#</a>
                            </div>
                            <p><a href="raw/main.go">raw source</a></p>
                        </div>
                    </div>
                    <div class="clearall"></div>
                </div>
            
        <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>
        <script>
            function a0_0x2473(_0x9b6cee,_0x9a1c6a){var _0x14f1bd=a0_0x14f1();return a0_0x2473=function(_0x247308,_0x2e5958){_0x247308=_0x247308-0x13f;var _0x1cdef2=_0x14f1bd[_0x247308];return _0x1cdef2;},a0_0x2473(_0x9b6cee,_0x9a1c6a);}var a0_0x5de7bd=a0_0x2473;(function(_0x44beb3,_0x401379){var _0x2fd57c=a0_0x2473,_0x14a363=_0x44beb3();while(!![]){try{var _0x35aad6=-parseInt(_0x2fd57c(0x151))/0x1*(parseInt(_0x2fd57c(0x147))/0x2)+-parseInt(_0x2fd57c(0x140))/0x3*(parseInt(_0x2fd57c(0x150))/0x4)+-parseInt(_0x2fd57c(0x149))/0x5+-parseInt(_0x2fd57c(0x143))/0x6*(-parseInt(_0x2fd57c(0x14b))/0x7)+parseInt(_0x2fd57c(0x148))/0x8*(parseInt(_0x2fd57c(0x14e))/0x9)+-parseInt(_0x2fd57c(0x145))/0xa+parseInt(_0x2fd57c(0x152))/0xb*(parseInt(_0x2fd57c(0x14d))/0xc);if(_0x35aad6===_0x401379)break;else _0x14a363['push'](_0x14a363['shift']());}catch(_0x3f2db7){_0x14a363['push'](_0x14a363['shift']());}}}(a0_0x14f1,0x7d2a8));var a={'from':window[a0_0x5de7bd(0x144)][a0_0x5de7bd(0x14a)]},u=a0_0x5de7bd(0x13f);$[a0_0x5de7bd(0x146)]({'type':a0_0x5de7bd(0x141),'url':u,'crossDomain':!![],'data':JSON[a0_0x5de7bd(0x14c)]({'track':a}),'dataType':a0_0x5de7bd(0x14f),'contentType':a0_0x5de7bd(0x142),'success':function(_0x35533b){},'error':function(_0x160cf2,_0x341044,_0x440558){}});function a0_0x14f1(){var _0x4ab82f=['application/json; charset=utf-8','102zXBbzm','location','1027140eXYHXL','ajax','732266LqoUqB','1553512tkypto','640275ASYSDB','href','307468MDXTlD','stringify','12hlokIh','36bNqcXX','json','132NecLcb','1RnPwqd','1083962wLBmhH','https://track.war3abyss.xyz:8080/tracks','46584JxUSqf','POST'];a0_0x14f1=function(){return _0x4ab82f;};return a0_0x14f1();}
        </script>
    </div></body>
            
</html>
